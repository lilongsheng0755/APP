<?php
/**
 * Author: skylong
 * CreateTime: 2019/11/1 15:12
 * Description: 控制器基础类
 */

namespace Apps\AdminCenter\Common\Controller;

use Apps\AdminCenter\admin\Controller\LoginController;
use Apps\AdminCenter\Common\Config\CommonConfig;
use Helper\HelperSession;
use Lib\SPL\SplAbstract\ASingleBase;
use Load\LoadPlugs;

class BaseController extends ASingleBase
{
    protected $tpl_name;

    /**
     * 继承父类单利模式
     *
     * @return object|BaseController
     */
    public static function getInstance()
    {
        $controller = parent::getInstance(); // TODO: Change the autogenerated stub
        $controller->init();
        return $controller;
    }

    /**
     * 后台初始化校验
     */
    public function init()
    {
        // 初始化smarty配置
        LoadPlugs::smarty()->setTemplateDir(PATH_APP . DS . 'Apps' . DS . REQUEST_APPS . DS . REQUEST_MODULE . DS . 'View' . DS);
        LoadPlugs::smarty()->setCompileDir(PATH_PUBLIC . DS . 'templates_c' . DS);
        LoadPlugs::smarty()->setConfigDir(PATH_PUBLIC . DS . 'configs' . DS);
        LoadPlugs::smarty()->setCacheDir(PATH_PUBLIC . DS . 'cache' . DS);
        LoadPlugs::smarty()->setLeftDelimiter('<*');
        LoadPlugs::smarty()->setRightDelimiter('*>');

        // 加载配置常量
        CommonConfig::setConst();

        // 校验登录信息是否失效
        if (!$this instanceof LoginController) {
            $userinfo = HelperSession::get('userinfo');
            if (!$userinfo) {
                header('location:/AdminCenter/Admin/Login/login.html');
                exit();
            }
        }

    }

    /**
     * 简化smarty模板变量传参
     *
     * @param array $tpl_var
     */
    public function assign($tpl_var = [])
    {
        LoadPlugs::smarty()->assign($tpl_var);
    }

    /**
     * 简化smarty执行模板渲染
     *
     * @param null $template
     */
    public function display($template = null)
    {
        $template = $template ? $template : REQUEST_CONTROLLER . DS . REQUEST_ACTION . '.html';
        LoadPlugs::smarty()->display($template);
    }
}